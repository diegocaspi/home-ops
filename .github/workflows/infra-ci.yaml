name: Infrastructure CI

on:
  pull_request:
    branches:
      - main
    paths:
      - "infrastructure/**"
      - ".github/workflows/infra-ci.yaml"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write

jobs:
  detect-modules:
    name: Detect Infrastructure Modules
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.detect.outputs.modules }}
      modules_env: ${{ steps.detect.outputs.modules_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect All Modules
        id: detect
        run: |
          # Find all module directories in infrastructure/hosts/
          MODULES=$(find infrastructure/hosts -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | jq -R -s -c 'split("\n")[:-1]')
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "All modules: $MODULES"

          # Generate environment variable names for each module (e.g., hypnos -> HYPNOS)
          MODULES_ENV=$(echo "$MODULES" | jq -r '.[] | gsub("-"; "_") | ascii_upcase' | jq -R -s -c 'split("\n")[:-1]')
          echo "modules_env=$MODULES_ENV" >> $GITHUB_OUTPUT
          echo "Module env names: $MODULES_ENV"

  plan:
    name: Terragrunt Plan (All Modules)
    runs-on: ubuntu-latest
    needs: detect-modules
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          audience: ${{ secrets.TS_AUDIENCE }}
          tags: tag:ci

      - uses: 1password/load-secrets-action/configure@v3
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Generate 1Password Secret Mappings
        id: generate-op-env
        run: |
          MODULES='${{ needs.detect-modules.outputs.modules }}'
          touch ./.env.tpl

          echo "R2_ACCESS_KEY=op://Homelab/cloudflare-r2/access-key" >> ./.env.tpl
          echo "R2_ACCESS_SECRET=op://Homelab/cloudflare-r2/secret-key" >> ./.env.tpl
          echo "CLOUDFLARE_ACCOUNT_ID=op://Homelab/cloudflare-r2/account-id" >> ./.env.tpl

          # Add environment variables for each module
          echo "$MODULES" | jq -r '.[]' | while read -r module; do
            # Convert module name to uppercase with underscores (e.g., hypnos -> HYPNOS)
            env_name=$(echo "$module" | tr '[:lower:]' '[:upper:]' | tr '-' '_')

            echo "PROXMOX_${env_name}_API_TOKEN=op://Homelab/proxmox-${module}/api-token" >> ./.env.tpl
            echo "PROXMOX_${env_name}_SSH_KEY=op://Homelab/proxmox-${module}-ssh/private_key" >> ./.env.tpl
          done

          cat ./.env.tpl

      - name: Load Secrets from 1Password
        id: op
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_ENV_FILE: "./.env.tpl"

      - name: Setup SSH Agent
        run: |
          MODULES='${{ needs.detect-modules.outputs.modules }}'

          ssh_keys=''
          # Add all SSH keys to agent
          echo "$MODULES" | jq -r '.[]' | while read -r module; do
            env_name=$(echo "$module" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
            ssh_key_var="PROXMOX_${env_name}_SSH_KEY"
            echo "DEBUG: processing ${env_name}..."

            # Check if the SSH key variable exists and add it to the agent
            if [ -n "${!ssh_key_var}" ]; then
              echo "Adding SSH key for module: $module"

              # Accumulate keys
              if [ -z "$ssh_keys" ]; then
                ssh_keys="${!ssh_key_var}"
              else
                ssh_keys="${ssh_keys}"$'\n'"${!ssh_key_var}"
              fi
            fi
          done

          if [ -n "$ssh_keys" ]; then
            echo "MODULES_SSH_PRIVATE_KEY<<EOF" >> $GITHUB_ENV
            echo "$ssh_keys" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.MODULES_SSH_PRIVATE_KEY }}

      - name: Terragrunt Plan
        uses: gruntwork-io/terragrunt-action@v3
        with:
          tg_version: "latest"
          tofu_version: "latest"
          tg_dir: infrastructure
          tg_command: plan
          tg_comment: true
          tg_add_approve: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
