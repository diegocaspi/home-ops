name: Infrastructure CI

on:
  pull_request:
    branches:
      - main
    paths:
      - "infrastructure/**"
      - ".github/workflows/infra-ci.yaml"

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-modules:
    name: Detect Infrastructure Modules
    runs-on: ubuntu-latest
    outputs:
      modules: ${{ steps.detect.outputs.modules }}
      modules_env: ${{ steps.detect.outputs.modules_env }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect All Modules
        id: detect
        run: |
          # Find all module directories in infrastructure/hosts/
          MODULES=$(find infrastructure/hosts -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort | jq -R -s -c 'split("\n")[:-1]')
          echo "modules=$MODULES" >> $GITHUB_OUTPUT
          echo "All modules: $MODULES"

          # Generate environment variable names for each module (e.g., hypnos -> HYPNOS)
          MODULES_ENV=$(echo "$MODULES" | jq -r '.[] | gsub("-"; "_") | ascii_upcase' | jq -R -s -c 'split("\n")[:-1]')
          echo "modules_env=$MODULES_ENV" >> $GITHUB_OUTPUT
          echo "Module env names: $MODULES_ENV"

  plan:
    name: Terragrunt Plan (All Modules)
    runs-on: ubuntu-latest
    needs: detect-modules
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Generate 1Password Secret Mappings
        id: generate-op-env
        run: |
          MODULES='${{ needs.detect-modules.outputs.modules }}'
          touch /tmp/op-env.tpl

          # Add environment variables for each module
          echo "$MODULES" | jq -r '.[]' | while read -r module; do
            # Convert module name to uppercase with underscores (e.g., hypnos -> HYPNOS)
            env_name=$(echo "$module" | tr '[:lower:]' '[:upper:]' | tr '-' '_')

            echo "PROXMOX_${env_name}_API_TOKEN: op://homeops/proxmox-${module}/api-token" >> /tmp/op-env.tpl
            echo "PROXMOX_${env_name}_SSH_KEY: op://homeops/proxmox-${module}-ssh/private_key" >> /tmp/op-env.tpl
          done

          cat /tmp/op-env.txt

      - name: Load Secrets from 1Password
        id: op
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          R2_ACCESS_KEY: op://homeops/cloudflare-r2/access-key
          R2_ACCESS_SECRET: op://homeops/cloudflare-r2/secret-key
          CLOUDFLARE_ACCOUNT_ID: op://homeops/cloudflare-r2/account-id
          OP_ENV_FILE: "/tmp/op-env.tpl"

          # Dynamically load secrets for all detected modules
          # Note: We need to statically define these in the workflow
          # GitHub Actions doesn't support dynamic env generation in the env block
          # So we'll need to add them in a setup step instead

      - name: Setup SSH Agent
        run: |
          MODULES='${{ needs.detect-modules.outputs.modules }}'

          # Start SSH agent
          eval $(ssh-agent -s)
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV

          # Add all SSH keys to agent
          echo "$MODULES" | jq -r '.[]' | while read -r module; do
            env_name=$(echo "$module" | tr '[:lower:]' '[:upper:]' | tr '-' '_')
            ssh_key_var="PROXMOX_${env_name}_SSH_KEY"

            # Check if the SSH key variable exists and add it to the agent
            if [ -n "${!ssh_key_var}" ]; then
              echo "Adding SSH key for module: $module"
              echo "${!ssh_key_var}" | ssh-add -
            fi
          done

          # List loaded keys
          ssh-add -l

      - name: Terragrunt Plan
        uses: gruntwork-io/terragrunt-action@v2
        with:
          tg_version: "latest"
          tofu_version: "latest"
          tg_dir: infrastructure
          tg_command: plan
          tg_comment: true
          tg_add_approve: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
